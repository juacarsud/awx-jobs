---
- name: Register on Elastic for monitoring
  hosts: localhost
  connection: local
  tasks:
    # - name: Get Template facts
    #   vmware_vm_facts:
    #     hostname: '{{ vcenter_hostname }}'
    #     username: "{{ vcenter_username }}"
    #     password: "{{ vcenter_password }}"
    #     validate_certs: no
    #     vm_type: all
    #   register: r_template
    # - debug: var=r_template
    # - debug:
    #     msg: "{{ item.guest_fullname }}"
    #   with_items:
    #     - "{{ r_template.virtual_machines | json_query(query) }}"
    #   vars:
    #     query: "[?guest_name=='{{ vcenter_vm_template }}']"
    - debug: var=user
    - name: Create elastic Request
      template:
        src: ./template/request.j2
        dest: /tmp/request.json
    - name: Send request to elastic
      uri:
        url: https://10.73.13.226:9200/iacprov/_doc
        method: POST
        body: "{{ lookup('file','/tmp/request.json') }}"
        body_format: json
        user: "{{ elastic_user }}"
        password: "{{ elastic_password }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        return_content: yes
        validate_certs: no
        status_code: 201


